#!/usr/bin/env python

""" Runs Rtabmap through subprocess for environment mapping
 Created: 2/9/2022
"""

__author__ = "Mike Hagenow"

import rospy
import time
from std_msgs.msg import String, Float64
import numpy as np
import rospkg
import subprocess32

class EnvMapping:
    def __init__(self):
        rospy.init_node('env_mapping')
        self._p = None

        # Subscribe to start/stop mapping
        rospy.Subscriber("mappingToggle", String, self.mappingToggle)

        # rospack = rospkg.RosPack()
        # root_dir = rospack.get_path('corrective_shared_autonomy')

    def mappingToggle(self,data):
        if data.data == "on":
            self.startMapping()
        elif data.data == "off":
            self.stopMapping()

    def startMapping(self):
        if not self._p is None:
            self._p.kill()
        self._p = subprocess32.Popen(["roslaunch", "drone_panda", "mapping_rtabmap.launch"])
       
    def stopMapping(self):
        if self._p is None:
            self._p.terminate()


    # TODO:
    # 1. odom topic from panda location (remap topic)
    # 2. send map to rviz (occasionally)
    # 3. on stop, call out to create planes


       
if __name__ == "__main__":
    mapper = EnvMapping()
    rospy.spin()





