#!/usr/bin/env python

""" Runs Rtabmap through subprocess for environment mapping
 Created: 2/9/2022
"""

__author__ = "Mike Hagenow"

import rospy
import time
from std_msgs.msg import String, Float64
from sensor_msgs.msg import PointCloud2
import numpy as np
import rospkg
import subprocess32

class EnvMapping:
    def __init__(self):
        rospy.init_node('env_mapping')
        self._p = None
        self.lastcloud = None

        # Subscribe to start/stop mapping
        rospy.Subscriber("mappingToggle", String, self.mappingToggle)
        rospy.Subscriber("/rtabmap/cloud_map",PointCloud2,self.saveCloud)

    def saveCloud(self,data):
        self.lastcloud = data

    def mappingToggle(self,data):
        if data.data == "on":
            self.startMapping()
        elif data.data == "off":
            self.stopMapping()

    def startMapping(self):
        if self._p is not None:
            self._p.kill()
        self._p = subprocess32.Popen(["roslaunch", "drone_panda", "mapping_rtabmap.launch"])
       
    def stopMapping(self):
        if self._p is not None:
            self._p.terminate()

            # TODO: send cloud to plane finder
            
            saveCloud = False
            if saveCloud and self.lastcloud is not None:
                rospack = rospkg.RosPack()
                path = rospack.get_path('drone_panda')+'/saved_msgs/pc_new.txt'
                with open(path, 'w') as outfile:
                    outfile.write(self.lastcloud.serialize())

       
if __name__ == "__main__":
    mapper = EnvMapping()
    rospy.spin()





